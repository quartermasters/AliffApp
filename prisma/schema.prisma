// Aliff Services Database Schema
// Next.js 16 + Prisma + PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// AUTHENTICATION & USERS
// ============================================================================

enum Role {
  SUPER_ADMIN
  ADMIN
  RECRUITER
  INTERVIEWER
  USER
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime? @map("email_verified")
  password      String
  name          String?
  image         String?
  role          Role      @default(USER)

  // 2FA
  twoFactorEnabled Boolean @default(false) @map("two_factor_enabled")
  twoFactorSecret  String? @map("two_factor_secret")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  lastLogin DateTime? @map("last_login")

  // Relations
  accounts     Account[]
  sessions     Session[]
  jobPostings  JobPosting[]
  applications Application[]
  interviews   Interview[]
  leads        Lead[]
  activities   Activity[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================================================
// JOB POSTINGS & ATS
// ============================================================================

enum ServiceCategory {
  GOVCON
  SLED
  IT_SERVICES
  WRITING_SERVICES
}

enum JobStatus {
  DRAFT
  PUBLISHED
  CLOSED
  ARCHIVED
}

enum JobType {
  FULL_TIME
  PART_TIME
  CONTRACT
  INTERNSHIP
}

enum JobLocation {
  REMOTE
  HYBRID
  ON_SITE
}

model JobPosting {
  id          String          @id @default(cuid())
  title       String
  slug        String          @unique
  description String          @db.Text
  category    ServiceCategory // GOVCON, SLED, IT, WRITING

  // Job Details
  type        JobType
  location    JobLocation
  department  String?
  salary      String?         // PKR range for Pakistan market
  requirements String         @db.Text
  responsibilities String      @db.Text
  benefits    String?         @db.Text

  // Status
  status      JobStatus       @default(DRAFT)
  publishedAt DateTime?       @map("published_at")
  closedAt    DateTime?       @map("closed_at")

  // Metadata
  views       Int             @default(0)
  applicationsCount Int       @default(0) @map("applications_count")
  createdBy   String          @map("created_by")
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  // Relations
  creator      User                     @relation(fields: [createdBy], references: [id])
  applications Application[]
  distributions JobPostingDistribution[]

  @@map("job_postings")
}

enum ApplicationStatus {
  SUBMITTED
  SCREENING
  SHORTLISTED
  INTERVIEW_SCHEDULED
  INTERVIEWING
  OFFER_EXTENDED
  ACCEPTED
  REJECTED
  WITHDRAWN
}

model Application {
  id        String            @id @default(cuid())

  // Candidate Info
  firstName String            @map("first_name")
  lastName  String            @map("last_name")
  email     String
  phone     String?

  // Application Data
  resumeUrl String            @map("resume_url")
  coverLetter String?         @db.Text @map("cover_letter")
  linkedinUrl String?         @map("linkedin_url")
  portfolioUrl String?        @map("portfolio_url")
  githubUrl String?           @map("github_url")

  // AI-Parsed Resume Data (50+ fields)
  parsedData Json?            @map("parsed_data") // Full structured resume extraction

  // Status & Scoring
  status    ApplicationStatus @default(SUBMITTED)

  // Screening scores (0-100)
  screeningScore Float?       @map("screening_score") // Initial AI screening
  chatScore      Float?       @map("chat_score")      // Chat interview score
  testScore      Float?       @map("test_score")      // Skills test score
  overallScore   Float?       @map("overall_score")   // Combined score

  aiNotes   String?           @db.Text @map("ai_notes")
  humanNotes String?          @db.Text @map("human_notes")

  // Chat Interview
  chatTranscript Json?        @map("chat_transcript") // Full conversation history
  chatCompleted  Boolean      @default(false) @map("chat_completed")
  chatCompletedAt DateTime?   @map("chat_completed_at")

  // Relations
  jobId     String            @map("job_id")
  userId    String?           @map("user_id")
  providerId String?          @map("provider_id") // If converted to provider

  // Timestamps
  createdAt DateTime          @default(now()) @map("created_at")
  updatedAt DateTime          @updatedAt @map("updated_at")

  // Relations
  job        JobPosting        @relation(fields: [jobId], references: [id], onDelete: Cascade)
  user       User?             @relation(fields: [userId], references: [id])
  provider   Provider?         @relation(fields: [providerId], references: [id])
  interviews Interview[]
  tests      Test[]

  @@map("applications")
}

// ============================================================================
// INTERVIEWS
// ============================================================================

enum InterviewType {
  PHONE_SCREEN
  VIDEO_CALL
  IN_PERSON
  TECHNICAL
  BEHAVIORAL
  PANEL
}

enum InterviewStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  RESCHEDULED
  NO_SHOW
}

model Interview {
  id            String          @id @default(cuid())

  // Interview Details
  type          InterviewType
  status        InterviewStatus @default(SCHEDULED)
  scheduledAt   DateTime        @map("scheduled_at")
  duration      Int             // in minutes
  location      String?         // or meeting link
  notes         String?         @db.Text

  // Feedback
  rating        Int?            // 1-5
  feedback      String?         @db.Text
  recommendation String?        // hire, maybe, no hire

  // Relations
  applicationId String          @map("application_id")
  interviewerId String          @map("interviewer_id")

  // Timestamps
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")

  // Relations
  application   Application     @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  interviewer   User            @relation(fields: [interviewerId], references: [id])

  @@map("interviews")
}

// ============================================================================
// AI TESTING SYSTEM
// ============================================================================

enum TestType {
  TECHNICAL
  BEHAVIORAL
  SITUATIONAL
  WRITING
  CUSTOM
}

enum TestStatus {
  ASSIGNED
  IN_PROGRESS
  SUBMITTED
  GRADED
  EXPIRED
}

model Test {
  id            String     @id @default(cuid())

  // Test Details
  title         String
  type          TestType
  description   String?    @db.Text
  questions     Json       // Array of questions
  duration      Int        // in minutes
  context       Json?      // Supporting materials (fake RFP, project specs)

  // Status & Scoring
  status        TestStatus @default(ASSIGNED)

  // Multi-AI Consensus Scoring (Phase 3)
  gpt4Score     Float?     @map("gpt4_score")      // GPT-4 evaluation (0-100)
  claudeScore   Float?     @map("claude_score")    // Claude evaluation (0-100)
  geminiScore   Float?     @map("gemini_score")    // Gemini evaluation (0-100)
  consensusScore Float?    @map("consensus_score") // Average of 3 (final score)

  aiEvaluation  String?    @db.Text @map("ai_evaluation") // Detailed feedback
  feedback      Json?      // Structured feedback (strengths, weaknesses, recommendations)
  answers       Json?      // Candidate answers

  // Relations
  applicationId String     @map("application_id")

  // Timestamps
  assignedAt    DateTime   @default(now()) @map("assigned_at")
  startedAt     DateTime?  @map("started_at")
  submittedAt   DateTime?  @map("submitted_at")
  gradedAt      DateTime?  @map("graded_at")
  expiresAt     DateTime   @map("expires_at")

  // Relations
  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@map("tests")
}

// ============================================================================
// CRM & LEADS
// ============================================================================

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  PROPOSAL_SENT
  NEGOTIATION
  WON
  LOST
  ARCHIVED
}

enum LeadSource {
  WEBSITE
  REFERRAL
  LINKEDIN
  COLD_OUTREACH
  INBOUND
  PARTNER
  OTHER
}

model Lead {
  id          String     @id @default(cuid())

  // Company Info
  companyName String     @map("company_name")
  contactName String?    @map("contact_name")
  email       String
  phone       String?
  website     String?

  // Lead Details
  status      LeadStatus @default(NEW)
  source      LeadSource @default(WEBSITE)
  value       Float?     // Estimated contract value
  probability Int?       // Win probability %
  notes       String?    @db.Text

  // Qualification
  qualified   Boolean    @default(false)
  qualifiedAt DateTime?  @map("qualified_at")

  // Assignment
  assignedTo  String?    @map("assigned_to")

  // Timestamps
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  closedAt    DateTime?  @map("closed_at")

  // Relations
  assignee    User?      @relation(fields: [assignedTo], references: [id])
  activities  Activity[]

  @@map("leads")
}

// ============================================================================
// ACTIVITY LOG
// ============================================================================

enum ActivityType {
  EMAIL
  CALL
  MEETING
  NOTE
  TASK
  STATUS_CHANGE
  OTHER
}

model Activity {
  id          String       @id @default(cuid())

  type        ActivityType
  title       String
  description String?      @db.Text
  metadata    Json?        // Additional data

  // Relations
  userId      String       @map("user_id")
  leadId      String?      @map("lead_id")

  // Timestamps
  createdAt   DateTime     @default(now()) @map("created_at")

  // Relations
  user        User         @relation(fields: [userId], references: [id])
  lead        Lead?        @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@map("activities")
}

// ============================================================================
// LINKEDIN AUTOMATION
// ============================================================================

enum LinkedInPostStatus {
  DRAFT
  SCHEDULED
  PUBLISHED
  FAILED
}

model LinkedInPost {
  id          String              @id @default(cuid())

  content     String              @db.Text
  imageUrl    String?             @map("image_url")

  status      LinkedInPostStatus  @default(DRAFT)
  scheduledAt DateTime?           @map("scheduled_at")
  publishedAt DateTime?           @map("published_at")

  // Engagement
  views       Int                 @default(0)
  likes       Int                 @default(0)
  comments    Int                 @default(0)
  shares      Int                 @default(0)

  // Timestamps
  createdAt   DateTime            @default(now()) @map("created_at")
  updatedAt   DateTime            @updatedAt @map("updated_at")

  @@map("linkedin_posts")
}

// ============================================================================
// AI CHATBOT
// ============================================================================

enum ConversationStatus {
  ACTIVE
  RESOLVED
  ARCHIVED
}

model Conversation {
  id        String              @id @default(cuid())

  // Contact Info
  visitorId String?             @map("visitor_id") // Anonymous ID
  email     String?
  name      String?

  status    ConversationStatus  @default(ACTIVE)

  // Timestamps
  createdAt DateTime            @default(now()) @map("created_at")
  updatedAt DateTime            @updatedAt @map("updated_at")

  // Relations
  messages  Message[]

  @@map("conversations")
}

model Message {
  id             String       @id @default(cuid())

  content        String       @db.Text
  isAI           Boolean      @default(false) @map("is_ai")
  metadata       Json?        // AI metadata, intent, etc.

  conversationId String       @map("conversation_id")

  createdAt      DateTime     @default(now()) @map("created_at")

  // Relations
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@map("messages")
}

// ============================================================================
// PROVIDER TALENT POOL (CV BANK) - Phase 4
// ============================================================================

enum ProviderStatus {
  AVAILABLE
  BUSY
  INACTIVE
  SUSPENDED
}

model Provider {
  id               String         @id @default(cuid())

  // Core Info
  name             String
  email            String         @unique
  phone            String?
  location         String?
  timezone         String?

  // Professional Profile
  skills           String[]       // ["GOVCON", "RFP", "Past Performance"]
  yearsExperience  Int
  domains          String[]       // ["Healthcare", "Cybersecurity"]
  certifications   String[]
  clearance        String?
  category         ServiceCategory

  // Portfolio
  linkedinUrl      String?        @map("linkedin_url")
  githubUrl        String?        @map("github_url")
  portfolioUrl     String?        @map("portfolio_url")
  resumeUrl        String?        @map("resume_url")

  // Performance Metrics
  overallRating    Float?         @map("overall_rating") // Average of all projects (1-5)
  projectsCompleted Int           @default(0) @map("projects_completed")
  onTimeRate       Float?         @map("on_time_rate") // Percentage
  satisfactionAvg  Float?         @map("satisfaction_avg") // Average client rating

  // Availability & Compensation
  status           ProviderStatus @default(AVAILABLE)
  hoursPerWeek     Int?           @map("hours_per_week")
  hourlyRate       Float?         @map("hourly_rate") // In PKR
  preferredProjects String[]      @map("preferred_projects")

  // Engagement
  lastContacted    DateTime?      @map("last_contacted")
  responseTime     Int?           @map("response_time") // avg minutes to respond

  // Timestamps
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")

  // Relations
  sourceApplication Application[]
  reviews          ProviderReview[]

  @@map("providers")
}

// ============================================================================
// PROVIDER PERFORMANCE TRACKING - Phase 5
// ============================================================================

model ProviderReview {
  id           String   @id @default(cuid())

  providerId   String   @map("provider_id")
  projectId    String?  @map("project_id") // Reference to project (external system)

  // Ratings (1-5 scale)
  qualityRating      Float  @map("quality_rating")
  timelinessRating   Float  @map("timeliness_rating")
  communicationRating Float @map("communication_rating")
  overallRating      Float  @map("overall_rating")

  // Feedback
  strengths    String?  @db.Text
  improvements String?  @db.Text
  notes        String?  @db.Text

  // Metadata
  reviewedBy   String?  @map("reviewed_by") // ALIFF-CLIENT or human
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  provider     Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@map("provider_reviews")
}

// ============================================================================
// JOB POSTING DISTRIBUTION - Phase 5
// ============================================================================

enum PostingPlatform {
  INDEED
  LINKEDIN
  DICE
  STACK_OVERFLOW
  GITHUB_JOBS
  ANGEL_LIST
  APMP
  GOVCON_WIRE
  CLEARANCE_JOBS
  WRITER_ACCESS
  FACEBOOK
  INSTAGRAM
  TWITTER
  REDDIT
  CAREERS_PAGE
  OTHER
}

enum DistributionStatus {
  PENDING
  POSTED
  ACTIVE
  CLOSED
  FAILED
}

model JobPostingDistribution {
  id          String             @id @default(cuid())

  jobId       String             @map("job_id")
  platform    PostingPlatform
  status      DistributionStatus @default(PENDING)

  // Platform-specific
  externalId  String?            @map("external_id") // ID on external platform
  externalUrl String?            @map("external_url")

  // Analytics
  views       Int                @default(0)
  clicks      Int                @default(0)
  applications Int               @default(0)
  cost        Float?             // If paid posting (PKR)

  // Timestamps
  postedAt    DateTime?          @map("posted_at")
  expiresAt   DateTime?          @map("expires_at")
  closedAt    DateTime?          @map("closed_at")
  createdAt   DateTime           @default(now()) @map("created_at")

  // Relations
  job         JobPosting         @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@map("job_posting_distributions")
}
