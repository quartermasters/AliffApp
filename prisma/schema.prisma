// Aliff Services Database Schema
// Next.js 16 + Prisma + PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// AUTHENTICATION & USERS
// ============================================================================

enum Role {
  SUPER_ADMIN      // Full access - Operations Engine
  CLIENT           // View-only + Feedback - B2B/B2C clients
  TEAM_PROVIDER    // Anonymized execution - Contractors/providers
  CANDIDATE        // Application tracking - Job applicants
  ADMIN            // Legacy - can be deprecated
  RECRUITER        // Legacy - can be deprecated
  INTERVIEWER      // Legacy - can be deprecated
  USER             // Legacy - can be deprecated
}

enum UserStatus {
  ACTIVE           // Active user, can login
  PENDING          // Awaiting admin approval (for CLIENT signups)
  SUSPENDED        // Temporarily blocked
  INACTIVE         // Account deactivated
}

model User {
  id            String     @id @default(cuid())
  email         String     @unique
  emailVerified DateTime?  @map("email_verified")
  password      String
  name          String?
  image         String?
  role          Role       @default(USER)
  status        UserStatus @default(PENDING)

  // 2FA
  twoFactorEnabled Boolean @default(false) @map("two_factor_enabled")
  twoFactorSecret  String? @map("two_factor_secret")

  // Login Tracking (for audit trail)
  lastLoginAt DateTime? @map("last_login_at")
  lastLoginIp String?   @map("last_login_ip")
  loginCount  Int       @default(0) @map("login_count")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  accounts     Account[]
  sessions     Session[]
  jobPostings  JobPosting[]
  applications Application[]
  interviews   Interview[]
  leads        Lead[]
  activities   Activity[]
  auditLogs    AuditLog[]

  // Business Dashboard Relations
  projectsCreated       Project[]           @relation("ProjectCreator")
  teamAssignments       ProjectAssignment[] @relation("TeamMemberAssignments")
  assignerAssignments   ProjectAssignment[] @relation("AssignerAssignments")
  consensusReviews      ConsensusLog[]
  deliverablesSubmitted Deliverable[]       @relation("DeliverableSubmitter")
  deliverablesReviewed  Deliverable[]       @relation("DeliverableReviewer")
  deliverablesApproved  Deliverable[]       @relation("DeliverableApprover")
  projectUpdates        ProjectUpdate[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================================================
// AUDIT TRAIL
// ============================================================================

model AuditLog {
  id         String   @id @default(cuid())
  userId     String   @map("user_id")
  action     String   // "PROJECT_CREATE", "PROVIDER_ASSIGN", "DELIVERABLE_APPROVE", etc.
  resource   String   // "Project", "Candidate", "Deliverable", "SDLTask", etc.
  resourceId String?  @map("resource_id")
  metadata   Json?    // Additional context (old values, new values, etc.)
  ipAddress  String?  @map("ip_address")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================================================
// JOB POSTINGS & ATS
// ============================================================================

enum JobStatus {
  DRAFT
  PUBLISHED
  CLOSED
  ARCHIVED
}

enum JobType {
  FULL_TIME
  PART_TIME
  CONTRACT
  INTERNSHIP
}

enum JobLocation {
  REMOTE
  HYBRID
  ON_SITE
}

model JobPosting {
  id          String @id @default(cuid())
  title       String
  slug        String @unique
  description String @db.Text

  // Job Details
  type             JobType
  location         JobLocation
  department       String?
  salary           String?
  requirements     String      @db.Text
  responsibilities String      @db.Text
  benefits         String?     @db.Text

  // Status
  status      JobStatus @default(DRAFT)
  publishedAt DateTime? @map("published_at")
  closedAt    DateTime? @map("closed_at")

  // Metadata
  views     Int      @default(0)
  createdBy String   @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  creator            User                 @relation(fields: [createdBy], references: [id])
  applications       Application[]
  projectAssignments ProjectAssignment[] // Link to Business Dashboard
  externalPostings   ExternalJobPosting[] // Multi-platform tracking

  @@map("job_postings")
}

enum ApplicationStatus {
  SUBMITTED // Just submitted
  PARSING // AI extracting resume data
  INTERVIEWING // In embedded AI chat interview
  INTERVIEW_COMPLETE // Interview done, awaiting review
  SCREENING // AI resume screening
  SHORTLISTED // Passed initial screening
  INTERVIEW_SCHEDULED // Traditional interview scheduled
  UNDER_REVIEW // Human review in progress
  OFFER_EXTENDED
  ACCEPTED // Moving to CV Bank as VALIDATED
  REJECTED // Not a fit
  WITHDRAWN // Candidate dropped out
}

model Application {
  id String @id @default(cuid())

  // Candidate Info
  firstName String  @map("first_name")
  lastName  String  @map("last_name")
  email     String
  phone     String?

  // Application Data
  resumeUrl    String  @map("resume_url")
  coverLetter  String? @map("cover_letter") @db.Text
  linkedinUrl  String? @map("linkedin_url")
  portfolioUrl String? @map("portfolio_url")
  githubUrl    String? @map("github_url")

  // NEW: Dual Photo System
  uploadedPhotoUrl    String? @map("uploaded_photo_url") // Required headshot
  cvExtractedPhotoUrl String? @map("cv_extracted_photo_url") // Photo from resume
  photoMetadata       Json?   @map("photo_metadata") // Source, quality, dimensions

  // NEW: Salary & Compensation
  currentSalary  Float?  @map("current_salary") // Current hourly/annual
  expectedSalary Float?  @map("expected_salary") // Expected hourly/annual
  salaryType     String? @map("salary_type") // HOURLY or ANNUAL
  salaryNotes    String? @map("salary_notes") @db.Text

  // NEW: Availability
  hoursPerDay      Int?      @map("hours_per_day") // Hours available per day
  daysPerMonth     Int?      @map("days_per_month") // Days available per month
  startDate        DateTime? @map("start_date") // When can start
  employmentStatus String?   @map("employment_status") // AVAILABLE, EMPLOYED, etc

  // Status & Scoring
  status     ApplicationStatus @default(SUBMITTED)
  aiScore    Float?            @map("ai_score") // Resume fit score 0-100
  aiNotes    String?           @map("ai_notes") @db.Text
  humanNotes String?           @map("human_notes") @db.Text

  // NEW: Resume Parsing
  resumeText       String? @map("resume_text") @db.Text // Full extracted text
  resumeParsedData Json?   @map("resume_parsed_data") // 50+ extracted fields
  fitScore         Float?  @map("fit_score") // Initial match score 0-100

  // NEW: Interview Integration
  interviewCompleted  Boolean   @default(false) @map("interview_completed")
  interviewTranscript Json?     @map("interview_transcript") // Full conversation
  interviewScore      Float?    @map("interview_score") // Multi-AI consensus 0-100
  interviewDate       DateTime? @map("interview_date")

  // Relations
  jobId  String  @map("job_id")
  userId String? @map("user_id")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  job              JobPosting        @relation(fields: [jobId], references: [id], onDelete: Cascade)
  user             User?             @relation(fields: [userId], references: [id])
  interviews       Interview[]
  tests            Test[]
  candidate        Candidate? // If applicant becomes provider
  interviewSession InterviewSession? // NEW: AI Interview session

  @@map("applications")
}

// ============================================================================
// INTERVIEWS
// ============================================================================

enum InterviewType {
  PHONE_SCREEN
  VIDEO_CALL
  IN_PERSON
  TECHNICAL
  BEHAVIORAL
  PANEL
}

enum InterviewStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  RESCHEDULED
  NO_SHOW
}

model Interview {
  id String @id @default(cuid())

  // Interview Details
  type        InterviewType
  status      InterviewStatus @default(SCHEDULED)
  scheduledAt DateTime        @map("scheduled_at")
  duration    Int // in minutes
  location    String? // or meeting link
  notes       String?         @db.Text

  // Feedback
  rating         Int? // 1-5
  feedback       String? @db.Text
  recommendation String? // hire, maybe, no hire

  // Relations
  applicationId String @map("application_id")
  interviewerId String @map("interviewer_id")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  interviewer User        @relation(fields: [interviewerId], references: [id])

  @@map("interviews")
}

// ============================================================================
// AI INTERVIEW SYSTEM (ALIFF-RECRUITER)
// ============================================================================

enum QuestionCategory {
  EXPERIENCE_VALIDATION // Verify claimed experience
  PROBLEM_SOLVING // Scenario-based questions
  SKILLS_ASSESSMENT // Technical knowledge
  CULTURE_FIT // Working style, preferences
  AVAILABILITY // Logistics, commitment
}

// Interview Question Bank (100+ role-specific questions)
model InterviewQuestion {
  id       String           @id @default(cuid())
  category QuestionCategory

  // Question Content
  roleType          String[] // ["GOVCON", "SLED", "IT", "WRITER"]
  question          String   @db.Text
  followUpQuestions String[] // Adaptive follow-ups

  // Evaluation Criteria
  evaluationCriteria String   @db.Text
  idealAnswer        String?  @db.Text
  redFlags           String[] // Warning signs in answers

  // Usage Stats
  timesAsked Int    @default(0) @map("times_asked")
  avgScore   Float? @map("avg_score")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([category])
  @@index([roleType])
  @@map("interview_questions")
}

enum InterviewMode {
  CONVERSATIONAL // Free-flowing ALIFF chat (new prototype)
  STRUCTURED // Question-bank approach (existing)
}

enum InterviewStage {
  NOT_STARTED
  WELCOME // Stage 1: Warm welcome
  AVAILABILITY // Stage 2: Availability deep dive
  SKILLS // Stage 3: Skills & experience validation
  REMOTE_WORK // Stage 4: Remote work & communication
  COMPENSATION // Stage 5: Compensation & expectations
  MOTIVATION // Stage 6: Motivation & cultural fit
  CLOSING // Stage 7: Final questions & next steps
  COMPLETED // Interview finished
  ABANDONED // Candidate left mid-interview
}

// AI Interview Session (100% of applicants)
model InterviewSession {
  id            String @id @default(cuid())
  applicationId String @unique @map("application_id")

  // NEW: Interview Mode & Flow
  mode          InterviewMode  @default(CONVERSATIONAL)
  currentStage  InterviewStage @default(NOT_STARTED) @map("current_stage")
  stageProgress Json?          @map("stage_progress") // Track completed stages

  // Session Info
  startedAt   DateTime  @default(now()) @map("started_at")
  completedAt DateTime? @map("completed_at")
  duration    Int?      @default(0) // Seconds

  // Questions & Answers
  messages       Json     @default("[]") // Full conversation array [{role, content, timestamp}]
  questionsAsked String[] @map("questions_asked") // Question IDs from bank (for STRUCTURED mode)

  // NEW: Structured Data Extraction (from conversational interview)
  extractedData Json? @map("extracted_data") // {availability, skills, compensation, etc}

  // Multi-AI Evaluation
  gpt4Score      Float? @map("gpt4_score") // 0-100
  claudeScore    Float? @map("claude_score") // 0-100
  geminiScore    Float? @map("gemini_score") // 0-100
  consensusScore Float? @map("consensus_score") // Average

  // Feedback
  strengths        String[] @default([]) // Key strengths identified
  concerns         String[] @default([]) // Red flags or gaps
  recommendation   String? // PROCEED_TO_HUMAN_REVIEW, ADD_TO_TALENT_POOL, REJECT
  detailedFeedback String?  @map("detailed_feedback") @db.Text

  // Breakdown Scores (0-100 scale)
  availabilityFitScore Float? @default(0) @map("availability_fit_score") // NEW: Matches job hours/days
  technicalScore       Float? @default(0) @map("technical_score") // Skills proficiency
  communicationScore   Float? @default(0) @map("communication_score") // Grammar, clarity, professionalism
  motivationScore      Float? @default(0) @map("motivation_score") // Career goals alignment

  // Legacy breakdown scores (keep for backwards compatibility)
  experienceScore     Float? @map("experience_score") // 0-30
  problemSolvingScore Float? @map("problem_solving_score") // 0-20
  cultureFitScore     Float? @map("culture_fit_score") // 0-10

  // NEW: Red Flags Tracking
  redFlags     String[] @default([]) @map("red_flags") // List of detected issues
  redFlagScore Int?     @default(0) @map("red_flag_score") // Penalty points

  // Metadata
  userAgent String? @map("user_agent") // Browser info
  ipAddress String? @map("ip_address") // For fraud detection

  // NEW: Abandonment Tracking
  lastActivityAt        DateTime? @map("last_activity_at")
  remindersSent         Int       @default(0) @map("reminders_sent")
  allowResumeUntil      DateTime? @map("allow_resume_until") // 24h window
  abandonedReason       String?   @map("abandoned_reason") // timeout, explicit_exit, etc
  messagesBeforeAbandon Int?      @default(0) @map("messages_before_abandon")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@index([consensusScore])
  @@index([currentStage])
  @@index([mode])
  @@map("interview_sessions")
}

// ============================================================================
// AI TESTING SYSTEM
// ============================================================================

enum TestType {
  TECHNICAL
  BEHAVIORAL
  SITUATIONAL
  WRITING
  CUSTOM
}

enum TestStatus {
  ASSIGNED
  IN_PROGRESS
  SUBMITTED
  GRADED
  EXPIRED
}

model Test {
  id String @id @default(cuid())

  // Test Details
  title       String
  type        TestType
  description String?  @db.Text
  questions   Json // Array of questions
  duration    Int // in minutes

  // Status & Scoring
  status       TestStatus @default(ASSIGNED)
  score        Float?
  aiEvaluation String?    @map("ai_evaluation") @db.Text
  answers      Json? // Candidate answers

  // Relations
  applicationId String @map("application_id")

  // Timestamps
  assignedAt  DateTime  @default(now()) @map("assigned_at")
  startedAt   DateTime? @map("started_at")
  submittedAt DateTime? @map("submitted_at")
  expiresAt   DateTime  @map("expires_at")

  // Relations
  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@map("tests")
}

// ============================================================================
// PROVIDER TALENT POOL (CV BANK)
// ============================================================================

enum CandidateStatus {
  APPLIED // Just submitted application
  SCREENING // AI resume screening in progress
  INTERVIEWED // Completed AI interview
  VALIDATED // Passed all checks, in talent pool
  ACTIVE // Currently working on projects
  BUSY // Assigned to projects
  INACTIVE // In pool but not active
  BLACKLISTED // Blocked
  ARCHIVED // Opted out or disqualified
}

enum ClearanceLevel {
  NONE
  PUBLIC_TRUST
  SECRET
  TOP_SECRET
  TS_SCI
}

model Candidate {
  id            String @id @default(cuid())
  applicationId String @unique @map("application_id")

  // Core Info
  name     String
  email    String  @unique
  phone    String?
  location String? // City, Country
  timezone String?

  // NEW: Dual Photo System
  uploadedPhotoUrl    String? @map("uploaded_photo_url") // Required headshot from application
  cvExtractedPhotoUrl String? @map("cv_extracted_photo_url") // Photo extracted from resume
  photoMetadata       Json?   @map("photo_metadata") // Source, upload date, quality score

  // Professional Links
  linkedIn  String? @map("linkedin_url")
  github    String? @map("github_url")
  portfolio String? @map("portfolio_url")

  // Skills & Experience (extracted from resume + validated via tests)
  skills          String[] // ["GOVCON Proposal Writing", "Technical Writing", "FAR/DFARS"]
  yearsExperience Int            @default(0) @map("years_experience")
  domains         String[] // ["Healthcare", "Cybersecurity", "Federal IT"]
  certifications  String[] // ["PMP", "APMP", "CISSP"]
  clearance       ClearanceLevel @default(NONE)
  industryExp     String[]       @map("industry_experience") // Industries worked in
  tools           String[]       @default([]) // ["MS Word", "Shipley", "GPT-4"]
  languages       String[]       @default([]) // ["English", "Spanish", "Urdu"]

  // NEW: Salary & Compensation
  currentSalary  Float?  @map("current_salary") // Current hourly/annual rate
  expectedSalary Float?  @map("expected_salary") // Expected hourly/annual rate
  salaryType     String? @map("salary_type") // "HOURLY" or "ANNUAL"
  salaryNotes    String? @map("salary_notes") @db.Text
  hourlyRatePKR  Float?  @map("hourly_rate_pkr") // Pakistani Rupees (CONFIDENTIAL - admin only)

  // NEW: Availability (from application)
  hoursPerDay      Int?      @map("hours_per_day") // Available hours per day
  daysPerMonth     Int?      @map("days_per_month") // Available days per month
  startDate        DateTime? @map("start_date") // When can start
  employmentStatus String?   @map("employment_status") // "AVAILABLE", "EMPLOYED", "STUDENT"
  hoursPerWeek     Int?      @map("hours_per_week") // Legacy field

  // NEW: AI Interview Data
  interviewTranscript Json?     @map("interview_transcript") // Full conversation
  interviewScore      Float?    @map("interview_score") // 0-100 overall multi-AI score
  interviewScores     Json?     @map("interview_scores") // {gpt4: 85, claude: 88, gemini: 82}
  interviewFeedback   String?   @map("interview_feedback") @db.Text
  interviewDate       DateTime? @map("interview_date")

  // NEW: Screening Scores
  fitScore         Float? @map("fit_score") // Initial resume match 0-100
  skillsMatchScore Float? @map("skills_match_score") // Required skills match %
  experienceScore  Float? @map("experience_score") // Years experience adequacy

  // Performance Metrics (from completed projects)
  overallScore      Float @default(0) @map("overall_score") // 0-100 average
  projectsCompleted Int   @default(0) @map("projects_completed")
  onTimeRate        Float @default(0) @map("on_time_rate") // 0-100%
  satisfactionAvg   Float @default(0) @map("satisfaction_avg") // 0-5 stars
  revisionRate      Float @default(0) @map("revision_rate") // 0-100% (lower is better)

  // Status & Engagement
  status            CandidateStatus @default(APPLIED)
  preferredProjects String[]        @default([]) @map("preferred_projects") // ["GOVCON", "SLED"]

  // Pinecone Integration
  vectorEmbeddingId String? @unique @map("vector_embedding_id") // Reference to Pinecone vector
  searchEmbedding   Float[] @default([]) @map("search_embedding") // Vector embedding for semantic search

  // Engagement Tracking
  lastContacted   DateTime? @map("last_contacted")
  responseTime    Int?      @map("response_time") // avg minutes to respond
  emailEngagement Float?    @map("email_engagement") // open rate %
  smsEngagement   Float?    @map("sms_engagement") // response rate %

  // NEW: Application Metadata
  appliedForJobId   String   @map("applied_for_job_id") // Which job they originally applied for
  applicationDate   DateTime @default(now()) @map("application_date")
  applicationSource String?  @map("application_source") // "LinkedIn", "Indeed", "Referral"

  // Parsed Resume Data (JSON storage for 50+ fields)
  parsedResumeData Json?   @map("parsed_resume_data")
  resumeUrl        String? @map("resume_url") // Link to original resume
  resumeText       String? @map("resume_text") @db.Text // Full extracted text

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  activatedAt DateTime? @map("activated_at") // When hired as provider

  // Relations
  application        Application           @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  projectAssignments ProjectAssignment[]   @relation("CandidateAssignments")
  performanceReviews ProviderPerformance[]
  timeEntries        TimeEntry[]

  @@index([email])
  @@index([status])
  @@index([vectorEmbeddingId])
  @@index([appliedForJobId])
  @@index([applicationDate])
  @@map("candidates")
}

// ============================================================================
// PERFORMANCE TRACKING & TIME MONITORING
// ============================================================================

enum TimeEntryStatus {
  PENDING
  APPROVED
  REJECTED
  DISPUTED
}

model TimeEntry {
  id          String   @id @default(cuid())
  candidateId String   @map("candidate_id")
  projectId   String   @map("project_id")
  date        DateTime

  // Time Tracking
  hoursWorked   Float  @map("hours_worked")
  hoursClaimed  Float  @map("hours_claimed") // May differ if idle time detected
  hoursApproved Float? @map("hours_approved") // After AI/human review
  hoursRejected Float? @map("hours_rejected")
  idleMinutes   Int    @default(0) @map("idle_minutes")

  // Activity Monitoring (from Time Doctor/Hubstaff)
  activityPercent Float @default(0) @map("activity_percent") // 0-100
  screenshots     Json? // Array of screenshot URLs
  appsUsed        Json? @map("apps_used") // App/website tracking data

  // Fraud Detection
  redFlags Json? @map("red_flags") // Array of detected issues

  // Review
  status      TimeEntryStatus @default(PENDING)
  reviewedBy  String?         @map("reviewed_by") // "AI" or human reviewer ID
  reviewedAt  DateTime?       @map("reviewed_at")
  reviewNotes String?         @map("review_notes") @db.Text

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  candidate Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([candidateId])
  @@index([projectId])
  @@index([date])
  @@index([status])
  @@map("time_entries")
}

model ProviderPerformance {
  id                   String @id @default(cuid())
  candidateId          String @unique @map("candidate_id")
  currentHourlyRatePKR Float  @map("current_hourly_rate_pkr") // Pakistani Rupees

  // Rolling 30-day metrics
  avgActivity        Float @default(0) @map("avg_activity") // 0-100
  totalHoursApproved Float @default(0) @map("total_hours_approved")
  totalHoursRejected Float @default(0) @map("total_hours_rejected")
  approvalRate       Float @default(100) @map("approval_rate") // %
  avgClientRating    Float @default(0) @map("avg_client_rating") // 1-5 stars
  revisionRate       Float @default(0) @map("revision_rate") // % of deliverables needing revisions

  // Fraud Tracking
  fraudFlags     Int       @default(0) @map("fraud_flags")
  lastFraudDate  DateTime? @map("last_fraud_date")
  fraudIncidents Json?     @map("fraud_incidents") // Log of incidents

  // Rate History
  rateHistory    Json     @map("rate_history") // Array of {date, rate, reason}
  nextReviewDate DateTime @map("next_review_date")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  candidate Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@map("provider_performance")
}

// ============================================================================
// MULTI-PLATFORM JOB POSTING TRACKING
// ============================================================================

enum PostingStatus {
  DRAFT
  ACTIVE
  PAUSED
  EXPIRED
  CLOSED
}

enum PostingPlatform {
  INTERNAL_CAREERS_PAGE
  FACEBOOK
  LINKEDIN
  INDEED
  GLASSDOOR
  ZIPRECRUITER
  DICE
  STACKOVERFLOW
  GITHUB
  APMP
  GOVCONWIRE
  CLEARANCEJOBS
  OTHER
}

model ExternalJobPosting {
  id          String          @id @default(cuid())
  jobId       String          @map("job_id")
  platform    PostingPlatform
  externalUrl String?         @map("external_url")

  // Status
  status    PostingStatus @default(DRAFT)
  postedAt  DateTime?     @map("posted_at")
  expiresAt DateTime?     @map("expires_at")

  // Analytics
  views        Int   @default(0)
  clicks       Int   @default(0)
  applications Int   @default(0)
  cost         Float @default(0) // Ad spend (if paid posting)

  // Campaign tracking
  campaignId   String? @map("campaign_id") // For Facebook/LinkedIn campaigns
  adCreativeId String? @map("ad_creative_id")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  job JobPosting @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([platform])
  @@index([status])
  @@map("external_job_postings")
}

// ============================================================================
// CRM & LEADS
// ============================================================================

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  PROPOSAL_SENT
  NEGOTIATION
  WON
  LOST
  ARCHIVED
}

enum LeadSource {
  WEBSITE
  REFERRAL
  LINKEDIN
  COLD_OUTREACH
  INBOUND
  PARTNER
  OTHER
}

model Lead {
  id String @id @default(cuid())

  // Company Info
  companyName String  @map("company_name")
  contactName String? @map("contact_name")
  email       String
  phone       String?
  website     String?

  // Lead Details
  status      LeadStatus @default(NEW)
  source      LeadSource @default(WEBSITE)
  value       Float? // Estimated contract value
  probability Int? // Win probability %
  notes       String?    @db.Text

  // Qualification
  qualified   Boolean   @default(false)
  qualifiedAt DateTime? @map("qualified_at")

  // Assignment
  assignedTo String? @map("assigned_to")

  // Timestamps
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  closedAt  DateTime? @map("closed_at")

  // Relations
  assignee   User?      @relation(fields: [assignedTo], references: [id])
  activities Activity[]

  @@map("leads")
}

// ============================================================================
// ACTIVITY LOG
// ============================================================================

enum ActivityType {
  EMAIL
  CALL
  MEETING
  NOTE
  TASK
  STATUS_CHANGE
  OTHER
}

model Activity {
  id String @id @default(cuid())

  type        ActivityType
  title       String
  description String?      @db.Text
  metadata    Json? // Additional data

  // Relations
  userId String  @map("user_id")
  leadId String? @map("lead_id")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User  @relation(fields: [userId], references: [id])
  lead Lead? @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@map("activities")
}

// ============================================================================
// LINKEDIN AUTOMATION
// ============================================================================

enum LinkedInPostStatus {
  DRAFT
  SCHEDULED
  PUBLISHED
  FAILED
}

model LinkedInPost {
  id String @id @default(cuid())

  content  String  @db.Text
  imageUrl String? @map("image_url")

  status      LinkedInPostStatus @default(DRAFT)
  scheduledAt DateTime?          @map("scheduled_at")
  publishedAt DateTime?          @map("published_at")

  // Engagement
  views    Int @default(0)
  likes    Int @default(0)
  comments Int @default(0)
  shares   Int @default(0)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("linkedin_posts")
}

// ============================================================================
// AI CHATBOT
// ============================================================================

enum ConversationStatus {
  ACTIVE
  RESOLVED
  ARCHIVED
}

model Conversation {
  id String @id @default(cuid())

  // Contact Info
  visitorId String? @map("visitor_id") // Anonymous ID
  email     String?
  name      String?

  status ConversationStatus @default(ACTIVE)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  messages Message[]

  @@map("conversations")
}

model Message {
  id String @id @default(cuid())

  content  String  @db.Text
  isAI     Boolean @default(false) @map("is_ai")
  metadata Json? // AI metadata, intent, etc.

  conversationId String @map("conversation_id")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@map("messages")
}

// ============================================================================
// BUSINESS DASHBOARD - GOVCON/SLED PROPOSAL MANAGEMENT
// ============================================================================

enum ProjectStage {
  PENDING_REVIEW // Client submitted, awaiting Super Admin review
  INTAKE // Super Admin reviewing project details
  SDL_PROCESSING // SDL Triage running (AI analysis)
  HUMAN_VALIDATION // Awaiting human expert validation
  RECRUITER_HIRING // ALIFF-RECRUITER finding team members
  TEAM_EXECUTION // Team working on deliverables
  AI_VALIDATION // AI quality check on deliverables
  GOLD_GATE // Final human expert review
  CLIENT_APPROVAL // Client reviewing final proposal
  SUBMITTED // Proposal submitted to agency
  WON // Contract awarded
  LOST // Proposal rejected
}

enum SDLPhase {
  NOT_STARTED
  PHASE1_TRIAGE
  PHASE2_STRATEGIC_INTEL
  PHASE3_WIN_STRATEGY
  COMPLETED
}

enum ProjectStatus {
  ACTIVE
  COMPLETED
  ARCHIVED
  CANCELLED
}

// Main project model for RFP/Proposal projects
model Project {
  id              String  @id @default(cuid())
  projectCode     String  @unique @map("project_code") // PROJ-2025-001
  projectCodename String? @map("project_codename") // "Operation Phoenix" (anonymized for team)

  // Client Information
  clientName  String  @map("client_name")
  clientEmail String? @map("client_email")
  clientPhone String? @map("client_phone")

  // Project Details
  title              String
  solicitationNumber String?   @map("solicitation_number")
  contractValue      Float?    @map("contract_value")
  deadline           DateTime?
  industryCategory   String?   @map("industry_category")

  // SDL Integration
  sdlStatus          SDLPhase @default(NOT_STARTED) @map("sdl_status")
  sdlComplexityScore Int?     @map("sdl_complexity_score") // 1-10 from SDL Task 10
  sdlWinProbability  Int?     @map("sdl_win_probability") // 0-100% from SDL Task 26
  sdlTriageResultId  String?  @unique @map("sdl_triage_result_id") // Reference to SDL triage result JSON storage

  // Project Status
  currentStage       ProjectStage @default(PENDING_REVIEW) @map("current_stage")
  progressPercentage Int          @default(0) @map("progress_percentage")
  qualityScore       Int?         @map("quality_score") // 0-100
  anonymizeForTeam   Boolean      @default(true) @map("anonymize_for_team")

  // ALIFF-RECRUITER Integration
  recruiterJobPackage     Json?     @map("recruiter_job_package") // SDL-generated job descriptions
  recruiterPipelineStatus Json?     @map("recruiter_pipeline_status") // Pipeline status
  recruiterStatus         String?   @map("recruiter_status") // HIRING_IN_PROGRESS, etc.
  recruiterActivatedAt    DateTime? @map("recruiter_activated_at")

  // Metadata
  createdBy   String        @map("created_by")
  status      ProjectStatus @default(ACTIVE)
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")
  completedAt DateTime?     @map("completed_at")
  submittedAt DateTime?     @map("submitted_at")

  // Relations
  creator       User                @relation("ProjectCreator", fields: [createdBy], references: [id])
  documents     ProjectDocument[]
  assignments   ProjectAssignment[]
  sdlTasks      SDLTask[]
  deliverables  Deliverable[]
  updates       ProjectUpdate[]
  consensusLogs ConsensusLog[]
  timeEntries   TimeEntry[]

  @@index([projectCode])
  @@index([sdlStatus])
  @@index([currentStage])
  @@index([status])
  @@index([createdBy])
  @@map("projects")
}

enum SDLTaskPhase {
  PHASE1_TRIAGE
  PHASE2_STRATEGIC_INTEL
  PHASE3_WIN_STRATEGY
}

enum SDLTaskStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  ESCALATED_TO_HUMAN
}

enum AIProvider {
  OPENAI
  CLAUDE
  GEMINI
  GROK
}

// SDL Task Queue (34 tasks per project)
model SDLTask {
  id         String       @id @default(cuid())
  projectId  String       @map("project_id")
  taskNumber Int          @map("task_number") // 1-34
  taskName   String       @map("task_name")
  taskPhase  SDLTaskPhase @map("task_phase")

  // AI Routing
  primaryAI               AIProvider  @map("primary_ai")
  secondaryAI             AIProvider? @map("secondary_ai")
  requiresMultiAI         Boolean     @default(false) @map("requires_multi_ai")
  requiresHumanValidation Boolean     @default(false) @map("requires_human_validation")

  // Execution Status
  status   SDLTaskStatus @default(PENDING)
  priority String        @default("medium") // low, medium, high, critical

  // Results (JSON storage)
  primaryResult         Json? @map("primary_result")
  secondaryResult       Json? @map("secondary_result")
  consensusResult       Json? @map("consensus_result")
  humanValidationResult Json? @map("human_validation_result")
  confidenceScore       Int?  @map("confidence_score") // 0-100

  // Timing
  estimatedDurationMinutes Int?      @map("estimated_duration_minutes")
  startedAt                DateTime? @map("started_at")
  completedAt              DateTime? @map("completed_at")
  errorMessage             String?   @map("error_message") @db.Text

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  project       Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  consensusLogs ConsensusLog[]

  @@unique([projectId, taskNumber])
  @@index([projectId])
  @@index([status])
  @@index([taskPhase])
  @@map("sdl_tasks")
}

enum ConsensusType {
  FULL_CONSENSUS // All AIs agree (>80% similarity)
  MAJORITY_CONSENSUS // 2 out of 3 agree (60-80% similarity)
  SPLIT_DECISION // No consensus (<60% similarity)
  LOW_CONFIDENCE // AI confidence scores conflict
}

// Multi-AI Consensus Log
model ConsensusLog {
  id        String @id @default(cuid())
  sdlTaskId String @map("sdl_task_id")
  projectId String @map("project_id")
  taskName  String @map("task_name")

  // AI Outputs
  gpt5Output   Json? @map("gpt5_output")
  claudeOutput Json? @map("claude_output")
  geminiOutput Json? @map("gemini_output")

  // Consensus Analysis
  consensusType       ConsensusType @map("consensus_type")
  consensusConfidence Int?          @map("consensus_confidence") // 0-100
  finalResult         Json          @map("final_result")

  // Human Review (if escalated)
  escalatedToHuman Boolean @default(false) @map("escalated_to_human")
  humanReviewerId  String? @map("human_reviewer_id")
  humanDecision    Json?   @map("human_decision")
  humanNotes       String? @map("human_notes") @db.Text

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  sdlTask       SDLTask @relation(fields: [sdlTaskId], references: [id], onDelete: Cascade)
  project       Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  humanReviewer User?   @relation(fields: [humanReviewerId], references: [id])

  @@index([projectId])
  @@index([sdlTaskId])
  @@map("consensus_logs")
}

enum DocumentType {
  RFP_MAIN
  AMENDMENT
  ATTACHMENT
  PAST_PERFORMANCE
  CAPABILITY_STATEMENT
  DELIVERABLE
  SDL_OUTPUT
  OTHER
}

// Project Documents
model ProjectDocument {
  id           String       @id @default(cuid())
  projectId    String       @map("project_id")
  documentType DocumentType @map("document_type")
  fileName     String       @map("file_name")
  filePath     String       @map("file_path")
  fileSize     Int?         @map("file_size")

  // Access Control
  uploadedByType  String  @map("uploaded_by_type") // admin, client, team, system
  uploadedById    String? @map("uploaded_by_id")
  visibleToClient Boolean @default(false) @map("visible_to_client")
  visibleToTeam   Boolean @default(false) @map("visible_to_team")
  watermarked     Boolean @default(false)

  uploadedAt DateTime @default(now()) @map("uploaded_at")

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([documentType])
  @@map("project_documents")
}

enum AssignmentType {
  LEAD_RESEARCHER
  TECHNICAL_SME
  PROPOSAL_WRITER
  PRICING_ANALYST
  COMPLIANCE_REVIEWER
  OTHER
}

enum AssignmentStatus {
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// Project Assignments (Team Members)
model ProjectAssignment {
  id                    String         @id @default(cuid())
  projectId             String         @map("project_id")
  teamMemberId          String         @map("team_member_id") // Can be User or external provider
  candidateId           String?        @map("candidate_id") // If assigned from CV Bank
  assignmentType        AssignmentType @map("assignment_type")
  assignmentDescription String?        @map("assignment_description") @db.Text

  // ALIFF-RECRUITER Integration
  recruitedViaAliff Boolean @default(false) @map("recruited_via_aliff")
  jobPostingId      String? @map("job_posting_id") // Link to ATS

  // Tracking
  status         AssignmentStatus @default(ASSIGNED)
  hoursEstimated Float?           @map("hours_estimated")
  hoursActual    Float?           @map("hours_actual")
  deadline       DateTime?

  // Metadata
  assignedBy  String    @map("assigned_by")
  assignedAt  DateTime  @default(now()) @map("assigned_at")
  completedAt DateTime? @map("completed_at")

  // Relations
  project      Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  teamMember   User          @relation("TeamMemberAssignments", fields: [teamMemberId], references: [id])
  assigner     User          @relation("AssignerAssignments", fields: [assignedBy], references: [id])
  candidate    Candidate?    @relation("CandidateAssignments", fields: [candidateId], references: [id])
  jobPosting   JobPosting?   @relation(fields: [jobPostingId], references: [id])
  deliverables Deliverable[]

  @@index([projectId])
  @@index([teamMemberId])
  @@index([candidateId])
  @@index([status])
  @@map("project_assignments")
}

enum DeliverableType {
  RESEARCH_REPORT
  TECHNICAL_ANALYSIS
  PROPOSAL_DRAFT
  PRICING_PROPOSAL
  STUDY_NOTES
  ANNOTATED_RFP
  OTHER
}

enum DeliverableStatus {
  ASSIGNED
  IN_PROGRESS
  SUBMITTED
  UNDER_REVIEW
  REVISION_REQUESTED
  APPROVED
  REJECTED
}

// Deliverables
model Deliverable {
  id              String          @id @default(cuid())
  projectId       String          @map("project_id")
  assignmentId    String?         @map("assignment_id")
  deliverableType DeliverableType @map("deliverable_type")
  title           String
  description     String?         @db.Text

  // File
  filePath String? @map("file_path")
  fileSize Int?    @map("file_size")

  // Status & Quality
  status             DeliverableStatus @default(ASSIGNED)
  qualityScore       Int?              @map("quality_score") // 0-100 from AI validation
  aiValidationResult Json?             @map("ai_validation_result")

  // Review
  reviewerNotes    String? @map("reviewer_notes") @db.Text
  reviewerFeedback String? @map("reviewer_feedback") @db.Text
  clientFeedback   String? @map("client_feedback") @db.Text
  visibleToClient  Boolean @default(false) @map("visible_to_client")
  submittedById    String? @map("submitted_by_id")
  reviewedById     String? @map("reviewed_by_id")
  approvedById     String? @map("approved_by_id")

  // Timing
  dueDate     DateTime? @map("due_date")
  submittedAt DateTime? @map("submitted_at")
  reviewedAt  DateTime? @map("reviewed_at")
  approvedAt  DateTime? @map("approved_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  project     Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignment  ProjectAssignment? @relation(fields: [assignmentId], references: [id])
  submittedBy User?              @relation("DeliverableSubmitter", fields: [submittedById], references: [id])
  reviewedBy  User?              @relation("DeliverableReviewer", fields: [reviewedById], references: [id])
  approvedBy  User?              @relation("DeliverableApprover", fields: [approvedById], references: [id])

  @@index([projectId])
  @@index([status])
  @@map("deliverables")
}

enum UpdateVisibility {
  CLIENT_ONLY
  TEAM_ONLY
  SUPER_ADMIN_ONLY
  CLIENT_AND_SUPER_ADMIN
}

// Project Updates (curated by Super Admin for Client Portal)
model ProjectUpdate {
  id         String           @id @default(cuid())
  projectId  String           @map("project_id")
  title      String
  content    String           @db.Text
  visibility UpdateVisibility @default(CLIENT_AND_SUPER_ADMIN)

  // Metadata
  createdBy String   @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  creator User    @relation(fields: [createdBy], references: [id])

  @@index([projectId])
  @@index([visibility])
  @@map("project_updates")
}
